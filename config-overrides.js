const path = require('path')
const {
  override,
  overrideDevServer,
  addBundleVisualizer,
  addWebpackAlias,
  addWebpackPlugin,
  addBabelPlugin
} = require('customize-cra')
const FaviconsWebpackPlugin = require('favicons-webpack-plugin')
const WebpackPwaManifest = require('webpack-pwa-manifest')
const WebResourceHints = require('./WebResourceHints')
const CspHtmlWebpackPlugin = require('csp-html-webpack-plugin')

const {
  CSP_ENABLED = 'true',
  REACT_APP_PREECONNECT_DOMAINS = '',
  REACT_APP_ASSEST_DOMAIN = ''
} = process.env
const AppConfig = require('./AppConfig')
const { appInfo, theme, manifestInfo, favIcons } = AppConfig

const pwaManifestOptions = {
  name: appInfo.appName,
  short_name: appInfo.shortName,
  description: appInfo.appDescription,
  background_color: manifestInfo.background,
  start_url: manifestInfo.startUrl,
  display: manifestInfo.display,
  orientation: manifestInfo.orientation,
  crossorigin: null, // can be null, use-credentials or anonymous
  icons: manifestInfo.icons,
  ios: true
}

const faviconOptions = {
  // Your source logo (required)
  logo: favIcons.logo,
  // Enable caching and optionally specify the path to store cached data
  // Note: disabling caching may increase build times considerably
  cache: true,
  // Override the publicPath option usually read from webpack configuration
  // publicPath: '/static',
  // The directory to output the assets relative to the webpack output dir.
  // Relative string paths are allowed here ie '../public/static'. If this
  // option is not set, `prefix` is used.
  // outputPath: '/public/static',
  // Prefix path for generated assets
  // prefix: 'assets/',
  // Inject html links/metadata (requires html-webpack-plugin).
  // This option accepts arguments of different types:
  //  * boolean
  //    `false`: disables injection
  //    `true`: enables injection if that is not disabled in html-webpack-plugin
  //  * function
  //    any predicate that takes an instance of html-webpack-plugin and returns either
  //    `true` or `false` to control the injection of html metadata for the html files
  //    generated by this instance.
  inject: true,

  // Favicons configuration options (see below)
  favicons: {
    appName: appInfo.appName,
    appDescription: appInfo.appDescription,
    developerName: null,
    developerURL: null, // prevent retrieving from the nearest package.json
    background: theme.background,
    theme_color: theme.themeColor,
    icons: {
      coast: false,
      yandex: false
    }
  }
}

const webResourceHintsOptions = {
  preconnects: REACT_APP_PREECONNECT_DOMAINS.split(',')
}

const cspPolicy = {
  'base-uri': "'self'",
  'object-src': "'none'",
  'script-src': ["'unsafe-inline'", "'self'", "'unsafe-eval'"],
  'style-src': ["'unsafe-inline'", "'self'", "'unsafe-eval'", 'https://fonts.googleapis.com', `${REACT_APP_ASSEST_DOMAIN}`]
}

const cspOptions = {
  enabled: CSP_ENABLED === 'true',
  hashingMethod: 'sha256',
  hashEnabled: {
    'script-src': false,
    'style-src': false
  },
  nonceEnabled: {
    'script-src': true,
    'style-src': false
  }
}

module.exports = {
  webpack: override(
    addBabelPlugin([
      'babel-plugin-direct-import',
      { modules: ['@mui/system', '@mui/material', '@mui/icons-material'] }
    ]),
    addWebpackAlias({ src: path.resolve(__dirname, 'src/') }),
    addBundleVisualizer({}, true),
    addWebpackPlugin(new WebResourceHints(webResourceHintsOptions)),
    addWebpackPlugin(new CspHtmlWebpackPlugin(cspPolicy, cspOptions)),
    addWebpackPlugin(new FaviconsWebpackPlugin(faviconOptions)),
    addWebpackPlugin(new WebpackPwaManifest(pwaManifestOptions))
  ),
  devServer: overrideDevServer()
}
